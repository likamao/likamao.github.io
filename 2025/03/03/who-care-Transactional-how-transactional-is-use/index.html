

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="YI MING HUANG">
  <meta name="keywords" content="">
  
    <meta name="description" content="什么是 @Transactional ？第一个前提是什么是事务？是由N步数据库操作序列组成的逻辑执行单元，这系列操作要么全执行，要么全放弃执行。 为什么会有要么，要么的结果？这是由事务的特性决定ACID  A：Atomicity : 原子性 数据的变化只会有一种结果。   C：Consistency : 一致性 当数据发生变化时，需全部由一种状态，转变为另一种状态。   I: Isolation">
<meta property="og:type" content="article">
<meta property="og:title" content="who care @Transactional, how @transactional is use">
<meta property="og:url" content="http://example.com/2025/03/03/who-care-Transactional-how-transactional-is-use/index.html">
<meta property="og:site_name" content="南港听夏">
<meta property="og:description" content="什么是 @Transactional ？第一个前提是什么是事务？是由N步数据库操作序列组成的逻辑执行单元，这系列操作要么全执行，要么全放弃执行。 为什么会有要么，要么的结果？这是由事务的特性决定ACID  A：Atomicity : 原子性 数据的变化只会有一种结果。   C：Consistency : 一致性 当数据发生变化时，需全部由一种状态，转变为另一种状态。   I: Isolation">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-03-03T00:41:18.000Z">
<meta property="article:modified_time" content="2025-03-03T08:29:31.319Z">
<meta property="article:author" content="YI MING HUANG">
<meta property="article:tag" content="Spting">
<meta property="article:tag" content="Transactional">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>who care @Transactional, how @transactional is use - 南港听夏</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Have a nice day</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="who care @Transactional, how @transactional is use"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-03-03 08:41" pubdate>
          2025年3月3日 早上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.6k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          56 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">who care @Transactional, how @transactional is use</h1>
            
            
              <div class="markdown-body">
                
                <h2 id="什么是-Transactional-？"><a href="#什么是-Transactional-？" class="headerlink" title="什么是 @Transactional ？"></a>什么是 @Transactional ？</h2><h3 id="第一个前提是什么是事务？"><a href="#第一个前提是什么是事务？" class="headerlink" title="第一个前提是什么是事务？"></a>第一个前提是什么是事务？</h3><p>是由N步数据库操作序列组成的逻辑执行单元，这系列操作要么全执行，要么全放弃执行。</p>
<h3 id="为什么会有要么，要么的结果？"><a href="#为什么会有要么，要么的结果？" class="headerlink" title="为什么会有要么，要么的结果？"></a>为什么会有要么，要么的结果？</h3><p>这是由事务的特性决定<br>ACID</p>
<ul>
<li>A：Atomicity : 原子性<ul>
<li>数据的变化只会有一种结果。</li>
</ul>
</li>
<li>C：Consistency : 一致性<ul>
<li>当数据发生变化时，需全部由一种状态，转变为另一种状态。</li>
</ul>
</li>
<li>I: Isolation : 隔离性<ul>
<li>事务与事务之间保持隔离，每个事务内部的操作对其他事务不可见，也不会造成影响。</li>
</ul>
</li>
<li>D：Durability : 持久性<ul>
<li>事务一旦成功提交，所提交的结果数据将被永久的储存。直到下一次新的事务对其进行操作</li>
</ul>
</li>
</ul>
<h3 id="Transactional"><a href="#Transactional" class="headerlink" title="@Transactional"></a>@Transactional</h3><p>@Transactional 是 Spring 框架提供的声明式事务管理方式，理论上，如果采用了 @Transactional ，其范围内的代码流程对应事务管理遵守ACID。</p>
<p>这里是源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment"> * Copyright 2002-2022 the original author or authors.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class="hljs-comment"> * you may not use this file except in compliance with the License.</span><br><span class="hljs-comment"> * You may obtain a copy of the License at</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> *      https://www.apache.org/licenses/LICENSE-2.0</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * Unless required by applicable law or agreed to in writing, software</span><br><span class="hljs-comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="hljs-comment"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="hljs-comment"> * See the License for the specific language governing permissions and</span><br><span class="hljs-comment"> * limitations under the License.</span><br><span class="hljs-comment"> */</span><br><br><span class="hljs-keyword">package</span> org.springframework.transaction.annotation;<br><br><span class="hljs-keyword">import</span> java.lang.annotation.Documented;<br><span class="hljs-keyword">import</span> java.lang.annotation.ElementType;<br><span class="hljs-keyword">import</span> java.lang.annotation.Inherited;<br><span class="hljs-keyword">import</span> java.lang.annotation.Retention;<br><span class="hljs-keyword">import</span> java.lang.annotation.RetentionPolicy;<br><span class="hljs-keyword">import</span> java.lang.annotation.Target;<br><br><span class="hljs-keyword">import</span> org.springframework.core.annotation.AliasFor;<br><span class="hljs-keyword">import</span> org.springframework.transaction.TransactionDefinition;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Describes a transaction attribute on an individual method or on a class.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;When this annotation is declared at the class level, it applies as a default</span><br><span class="hljs-comment"> * to all methods of the declaring class and its subclasses. Note that it does not</span><br><span class="hljs-comment"> * apply to ancestor classes up the class hierarchy; inherited methods need to be</span><br><span class="hljs-comment"> * locally redeclared in order to participate in a subclass-level annotation. For</span><br><span class="hljs-comment"> * details on method visibility constraints, consult the</span><br><span class="hljs-comment"> * &lt;a href=&quot;https://docs.spring.io/spring-framework/docs/current/reference/html/data-access.html#transaction&quot;&gt;Transaction Management&lt;/a&gt;</span><br><span class="hljs-comment"> * section of the reference manual.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;This annotation is generally directly comparable to Spring&#x27;s</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.interceptor.RuleBasedTransactionAttribute&#125;</span><br><span class="hljs-comment"> * class, and in fact &#123;<span class="hljs-doctag">@link</span> AnnotationTransactionAttributeSource&#125; will directly</span><br><span class="hljs-comment"> * convert this annotation&#x27;s attributes to properties in &#123;<span class="hljs-doctag">@code</span> RuleBasedTransactionAttribute&#125;,</span><br><span class="hljs-comment"> * so that Spring&#x27;s transaction support code does not have to know about annotations.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;h3&gt;Attribute Semantics&lt;/h3&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;If no custom rollback rules are configured in this annotation, the transaction</span><br><span class="hljs-comment"> * will roll back on &#123;<span class="hljs-doctag">@link</span> RuntimeException&#125; and &#123;<span class="hljs-doctag">@link</span> Error&#125; but not on checked</span><br><span class="hljs-comment"> * exceptions.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Rollback rules determine if a transaction should be rolled back when a given</span><br><span class="hljs-comment"> * exception is thrown, and the rules are based on patterns. A pattern can be a</span><br><span class="hljs-comment"> * fully qualified class name or a substring of a fully qualified class name for</span><br><span class="hljs-comment"> * an exception type (which must be a subclass of &#123;<span class="hljs-doctag">@code</span> Throwable&#125;), with no</span><br><span class="hljs-comment"> * wildcard support at present. For example, a value of</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> &quot;javax.servlet.ServletException&quot;&#125; or &#123;<span class="hljs-doctag">@code</span> &quot;ServletException&quot;&#125; will</span><br><span class="hljs-comment"> * match &#123;<span class="hljs-doctag">@code</span> javax.servlet.ServletException&#125; and its subclasses.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Rollback rules may be configured via &#123;<span class="hljs-doctag">@link</span> #rollbackFor&#125;/&#123;<span class="hljs-doctag">@link</span> #noRollbackFor&#125;</span><br><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@link</span> #rollbackForClassName&#125;/&#123;<span class="hljs-doctag">@link</span> #noRollbackForClassName&#125;, which allow</span><br><span class="hljs-comment"> * patterns to be specified as &#123;<span class="hljs-doctag">@link</span> Class&#125; references or &#123;<span class="hljs-doctag">@linkplain</span> String</span><br><span class="hljs-comment"> * strings&#125;, respectively. When an exception type is specified as a class reference</span><br><span class="hljs-comment"> * its fully qualified name will be used as the pattern. Consequently,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Transactional</span>(rollbackFor = example.CustomException.class)&#125; is equivalent</span><br><span class="hljs-comment"> * to &#123;<span class="hljs-doctag">@code</span> <span class="hljs-doctag">@Transactional</span>(rollbackForClassName = &quot;example.CustomException&quot;)&#125;.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;&lt;strong&gt;WARNING:&lt;/strong&gt; You must carefully consider how specific the pattern</span><br><span class="hljs-comment"> * is and whether to include package information (which isn&#x27;t mandatory). For example,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> &quot;Exception&quot;&#125; will match nearly anything and will probably hide other</span><br><span class="hljs-comment"> * rules. &#123;<span class="hljs-doctag">@code</span> &quot;java.lang.Exception&quot;&#125; would be correct if &#123;<span class="hljs-doctag">@code</span> &quot;Exception&quot;&#125;</span><br><span class="hljs-comment"> * were meant to define a rule for all checked exceptions. With more unique</span><br><span class="hljs-comment"> * exception names such as &#123;<span class="hljs-doctag">@code</span> &quot;BaseBusinessException&quot;&#125; there is likely no</span><br><span class="hljs-comment"> * need to use the fully qualified class name for the exception pattern. Furthermore,</span><br><span class="hljs-comment"> * rollback rules may result in unintentional matches for similarly named exceptions</span><br><span class="hljs-comment"> * and nested classes. This is due to the fact that a thrown exception is considered</span><br><span class="hljs-comment"> * to be a match for a given rollback rule if the name of thrown exception contains</span><br><span class="hljs-comment"> * the exception pattern configured for the rollback rule. For example, given a</span><br><span class="hljs-comment"> * rule configured to match on &#123;<span class="hljs-doctag">@code</span> com.example.CustomException&#125;, that rule</span><br><span class="hljs-comment"> * would match against an exception named</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> com.example.CustomExceptionV2&#125; (an exception in the same package as</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> CustomException&#125; but with an additional suffix) or an exception named</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@code</span> com.example.CustomException$AnotherException&#125;</span><br><span class="hljs-comment"> * (an exception declared as a nested class in &#123;<span class="hljs-doctag">@code</span> CustomException&#125;).</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;For specific information about the semantics of other attributes in this</span><br><span class="hljs-comment"> * annotation, consult the &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.TransactionDefinition&#125;</span><br><span class="hljs-comment"> * and &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.interceptor.TransactionAttribute&#125; javadocs.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;h3&gt;Transaction Management&lt;/h3&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;This annotation commonly works with thread-bound transactions managed by a</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.PlatformTransactionManager&#125;, exposing a</span><br><span class="hljs-comment"> * transaction to all data access operations within the current execution thread.</span><br><span class="hljs-comment"> * &lt;b&gt;Note: This does NOT propagate to newly started threads within the method.&lt;/b&gt;</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Alternatively, this annotation may demarcate a reactive transaction managed</span><br><span class="hljs-comment"> * by a &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.ReactiveTransactionManager&#125; which</span><br><span class="hljs-comment"> * uses the Reactor context instead of thread-local variables. As a consequence,</span><br><span class="hljs-comment"> * all participating data access operations need to execute within the same</span><br><span class="hljs-comment"> * Reactor context in the same reactive pipeline.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Colin Sampaleanu</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Sam Brannen</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Mark Paluch</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.2</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.RuleBasedTransactionAttribute</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="hljs-meta">@Inherited</span><br><span class="hljs-meta">@Documented</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Transactional &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Alias for &#123;<span class="hljs-doctag">@link</span> #transactionManager&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #transactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@AliasFor(&quot;transactionManager&quot;)</span><br>	String <span class="hljs-title function_">value</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * A &lt;em&gt;qualifier&lt;/em&gt; value for the specified transaction.</span><br><span class="hljs-comment">	 * &lt;p&gt;May be used to determine the target transaction manager, matching the</span><br><span class="hljs-comment">	 * qualifier value (or the bean name) of a specific</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.TransactionManager TransactionManager&#125;</span><br><span class="hljs-comment">	 * bean definition.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 4.2</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #value</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.PlatformTransactionManager</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.ReactiveTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-meta">@AliasFor(&quot;value&quot;)</span><br>	String <span class="hljs-title function_">transactionManager</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Defines zero (0) or more transaction labels.</span><br><span class="hljs-comment">	 * &lt;p&gt;Labels may be used to describe a transaction, and they can be evaluated</span><br><span class="hljs-comment">	 * by individual transaction managers. Labels may serve a solely descriptive</span><br><span class="hljs-comment">	 * purpose or map to pre-defined transaction manager-specific options.</span><br><span class="hljs-comment">	 * &lt;p&gt;See the documentation of the actual transaction manager implementation</span><br><span class="hljs-comment">	 * for details on how it evaluates transaction labels.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 5.3</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute#getLabels()</span><br><span class="hljs-comment">	 */</span><br>	String[] label() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The transaction propagation type.</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRED&#125;.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute#getPropagationBehavior()</span><br><span class="hljs-comment">	 */</span><br>	Propagation <span class="hljs-title function_">propagation</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Propagation.REQUIRED;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The transaction isolation level.</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to &#123;<span class="hljs-doctag">@link</span> Isolation#DEFAULT&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;Exclusively designed for use with &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRED&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRES_NEW&#125; since it only applies to newly started</span><br><span class="hljs-comment">	 * transactions. Consider switching the &quot;validateExistingTransactions&quot; flag to</span><br><span class="hljs-comment">	 * &quot;true&quot; on your transaction manager if you&#x27;d like isolation level declarations</span><br><span class="hljs-comment">	 * to get rejected when participating in an existing transaction with a different</span><br><span class="hljs-comment">	 * isolation level.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute#getIsolationLevel()</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#setValidateExistingTransaction</span><br><span class="hljs-comment">	 */</span><br>	Isolation <span class="hljs-title function_">isolation</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Isolation.DEFAULT;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The timeout for this transaction (in seconds).</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to the default timeout of the underlying transaction system.</span><br><span class="hljs-comment">	 * &lt;p&gt;Exclusively designed for use with &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRED&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRES_NEW&#125; since it only applies to newly started</span><br><span class="hljs-comment">	 * transactions.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the timeout in seconds</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute#getTimeout()</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> TransactionDefinition.TIMEOUT_DEFAULT;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * The timeout for this transaction (in seconds).</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to the default timeout of the underlying transaction system.</span><br><span class="hljs-comment">	 * &lt;p&gt;Exclusively designed for use with &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRED&#125; or</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> Propagation#REQUIRES_NEW&#125; since it only applies to newly started</span><br><span class="hljs-comment">	 * transactions.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@return</span> the timeout in seconds as a String value, e.g. a placeholder</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@since</span> 5.3</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute#getTimeout()</span><br><span class="hljs-comment">	 */</span><br>	String <span class="hljs-title function_">timeoutString</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * A boolean flag that can be set to &#123;<span class="hljs-doctag">@code</span> true&#125; if the transaction is</span><br><span class="hljs-comment">	 * effectively read-only, allowing for corresponding optimizations at runtime.</span><br><span class="hljs-comment">	 * &lt;p&gt;Defaults to &#123;<span class="hljs-doctag">@code</span> false&#125;.</span><br><span class="hljs-comment">	 * &lt;p&gt;This just serves as a hint for the actual transaction subsystem;</span><br><span class="hljs-comment">	 * it will &lt;i&gt;not necessarily&lt;/i&gt; cause failure of write access attempts.</span><br><span class="hljs-comment">	 * A transaction manager which cannot interpret the read-only hint will</span><br><span class="hljs-comment">	 * &lt;i&gt;not&lt;/i&gt; throw an exception when asked for a read-only transaction</span><br><span class="hljs-comment">	 * but rather silently ignore the hint.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.TransactionAttribute#isReadOnly()</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.TransactionSynchronizationManager#isCurrentTransactionReadOnly()</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">boolean</span> <span class="hljs-title function_">readOnly</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Defines zero (0) or more exception &#123;<span class="hljs-doctag">@linkplain</span> Class classes&#125;, which must be</span><br><span class="hljs-comment">	 * subclasses of &#123;<span class="hljs-doctag">@link</span> Throwable&#125;, indicating which exception types must cause</span><br><span class="hljs-comment">	 * a transaction rollback.</span><br><span class="hljs-comment">	 * &lt;p&gt;By default, a transaction will be rolled back on &#123;<span class="hljs-doctag">@link</span> RuntimeException&#125;</span><br><span class="hljs-comment">	 * and &#123;<span class="hljs-doctag">@link</span> Error&#125; but not on checked exceptions (business exceptions). See</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute#rollbackOn(Throwable)&#125;</span><br><span class="hljs-comment">	 * for a detailed explanation.</span><br><span class="hljs-comment">	 * &lt;p&gt;This is the preferred way to construct a rollback rule (in contrast to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> #rollbackForClassName&#125;), matching the exception type, its subclasses,</span><br><span class="hljs-comment">	 * and its nested classes. See the &#123;<span class="hljs-doctag">@linkplain</span> Transactional class-level javadocs&#125;</span><br><span class="hljs-comment">	 * for further details on rollback rule semantics and warnings regarding possible</span><br><span class="hljs-comment">	 * unintentional matches.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #rollbackForClassName</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.RollbackRuleAttribute#RollbackRuleAttribute(Class)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute#rollbackOn(Throwable)</span><br><span class="hljs-comment">	 */</span><br>	Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] rollbackFor() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Defines zero (0) or more exception name patterns (for exceptions which must be a</span><br><span class="hljs-comment">	 * subclass of &#123;<span class="hljs-doctag">@link</span> Throwable&#125;), indicating which exception types must cause</span><br><span class="hljs-comment">	 * a transaction rollback.</span><br><span class="hljs-comment">	 * &lt;p&gt;See the &#123;<span class="hljs-doctag">@linkplain</span> Transactional class-level javadocs&#125; for further details</span><br><span class="hljs-comment">	 * on rollback rule semantics, patterns, and warnings regarding possible</span><br><span class="hljs-comment">	 * unintentional matches.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #rollbackFor</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.RollbackRuleAttribute#RollbackRuleAttribute(String)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute#rollbackOn(Throwable)</span><br><span class="hljs-comment">	 */</span><br>	String[] rollbackForClassName() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Defines zero (0) or more exception &#123;<span class="hljs-doctag">@link</span> Class Classes&#125;, which must be</span><br><span class="hljs-comment">	 * subclasses of &#123;<span class="hljs-doctag">@link</span> Throwable&#125;, indicating which exception types must</span><br><span class="hljs-comment">	 * &lt;b&gt;not&lt;/b&gt; cause a transaction rollback.</span><br><span class="hljs-comment">	 * &lt;p&gt;This is the preferred way to construct a rollback rule (in contrast to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> #noRollbackForClassName&#125;), matching the exception type, its subclasses,</span><br><span class="hljs-comment">	 * and its nested classes. See the &#123;<span class="hljs-doctag">@linkplain</span> Transactional class-level javadocs&#125;</span><br><span class="hljs-comment">	 * for further details on rollback rule semantics and warnings regarding possible</span><br><span class="hljs-comment">	 * unintentional matches.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #noRollbackForClassName</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.NoRollbackRuleAttribute#NoRollbackRuleAttribute(Class)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute#rollbackOn(Throwable)</span><br><span class="hljs-comment">	 */</span><br>	Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] noRollbackFor() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Defines zero (0) or more exception name patterns (for exceptions which must be a</span><br><span class="hljs-comment">	 * subclass of &#123;<span class="hljs-doctag">@link</span> Throwable&#125;) indicating which exception types must &lt;b&gt;not&lt;/b&gt;</span><br><span class="hljs-comment">	 * cause a transaction rollback.</span><br><span class="hljs-comment">	 * &lt;p&gt;See the &#123;<span class="hljs-doctag">@linkplain</span> Transactional class-level javadocs&#125; for further details</span><br><span class="hljs-comment">	 * on rollback rule semantics, patterns, and warnings regarding possible</span><br><span class="hljs-comment">	 * unintentional matches.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> #noRollbackFor</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.NoRollbackRuleAttribute#NoRollbackRuleAttribute(String)</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.interceptor.DefaultTransactionAttribute#rollbackOn(Throwable)</span><br><span class="hljs-comment">	 */</span><br>	String[] noRollbackForClassName() <span class="hljs-keyword">default</span> &#123;&#125;;<br><br>&#125;<br><br></code></pre></td></tr></table></figure>
<p>这里可以看到  Propagation（传播属性） 默认的是 REQUIRED，也就是多个事务互相调用时，事务如何在这些方法间传播。</p>
<p>这里可以看下 Propagation 这个枚举类的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> org.springframework.transaction.annotation;<br><br><span class="hljs-keyword">import</span> org.springframework.transaction.TransactionDefinition;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Enumeration that represents transaction propagation behaviors for use</span><br><span class="hljs-comment"> * with the &#123;<span class="hljs-doctag">@link</span> Transactional&#125; annotation, corresponding to the</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> TransactionDefinition&#125; interface.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Colin Sampaleanu</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> Juergen Hoeller</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@since</span> 1.2</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Propagation</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction, create a new one if none exists.</span><br><span class="hljs-comment">	 * Analogous to EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;This is the default setting of a transaction annotation.</span><br><span class="hljs-comment">	 */</span><br>	REQUIRED(TransactionDefinition.PROPAGATION_REQUIRED),<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction, execute non-transactionally if none exists.</span><br><span class="hljs-comment">	 * Analogous to EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note: For transaction managers with transaction synchronization,</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> SUPPORTS&#125; is slightly different from no transaction at all,</span><br><span class="hljs-comment">	 * as it defines a transaction scope that synchronization will apply for.</span><br><span class="hljs-comment">	 * As a consequence, the same resources (JDBC Connection, Hibernate Session, etc)</span><br><span class="hljs-comment">	 * will be shared for the entire specified scope. Note that this depends on</span><br><span class="hljs-comment">	 * the actual synchronization configuration of the transaction manager.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#setTransactionSynchronization</span><br><span class="hljs-comment">	 */</span><br>	SUPPORTS(TransactionDefinition.PROPAGATION_SUPPORTS),<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction, throw an exception if none exists.</span><br><span class="hljs-comment">	 * Analogous to EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 */</span><br>	MANDATORY(TransactionDefinition.PROPAGATION_MANDATORY),<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create a new transaction, and suspend the current transaction if one exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual transaction suspension will not work out-of-the-box</span><br><span class="hljs-comment">	 * on all transaction managers. This in particular applies to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.jta.JtaTransactionManager&#125;,</span><br><span class="hljs-comment">	 * which requires the &#123;<span class="hljs-doctag">@code</span> javax.transaction.TransactionManager&#125; to be</span><br><span class="hljs-comment">	 * made available to it (which is server-specific in standard Java EE).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	REQUIRES_NEW(TransactionDefinition.PROPAGATION_REQUIRES_NEW),<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Execute non-transactionally, suspend the current transaction if one exists.</span><br><span class="hljs-comment">	 * Analogous to EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual transaction suspension will not work out-of-the-box</span><br><span class="hljs-comment">	 * on all transaction managers. This in particular applies to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.jta.JtaTransactionManager&#125;,</span><br><span class="hljs-comment">	 * which requires the &#123;<span class="hljs-doctag">@code</span> javax.transaction.TransactionManager&#125; to be</span><br><span class="hljs-comment">	 * made available to it (which is server-specific in standard Java EE).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	NOT_SUPPORTED(TransactionDefinition.PROPAGATION_NOT_SUPPORTED),<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Execute non-transactionally, throw an exception if a transaction exists.</span><br><span class="hljs-comment">	 * Analogous to EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 */</span><br>	NEVER(TransactionDefinition.PROPAGATION_NEVER),<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Execute within a nested transaction if a current transaction exists,</span><br><span class="hljs-comment">	 * behave like &#123;<span class="hljs-doctag">@code</span> REQUIRED&#125; otherwise. There is no analogous feature in EJB.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note: Actual creation of a nested transaction will only work on specific</span><br><span class="hljs-comment">	 * transaction managers. Out of the box, this only applies to the JDBC</span><br><span class="hljs-comment">	 * DataSourceTransactionManager. Some JTA providers might support nested</span><br><span class="hljs-comment">	 * transactions as well.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.jdbc.datasource.DataSourceTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	NESTED(TransactionDefinition.PROPAGATION_NESTED);<br><br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> value;<br><br><br>	Propagation(<span class="hljs-type">int</span> value) &#123;<br>		<span class="hljs-built_in">this</span>.value = value;<br>	&#125;<br><br>	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">value</span><span class="hljs-params">()</span> &#123;<br>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.value;<br>	&#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>对源码的解释：</p>
<ul>
<li><p><strong>PROPAGATION_REQUIRED</strong></p>
<ul>
<li>支持当前事务，如果当前存在事务，则加入该事务。</li>
<li>如果当前没有事务，则新建一个事务。</li>
<li><strong>场景：适用于大多数需要事务支持的操作。例如，当你有一个方法需要确保所有数据库操作要么全部成功，要么全部失败时，可以使用这个属性。</strong></li>
</ul>
</li>
<li><p><strong>PROPAGATION_SUPPORTS</strong></p>
<ul>
<li>支持当前事务，如果当前存在事务，则加入该事务。</li>
<li>如果当前没有事务，则以非事务方式执行。</li>
<li>比如两个实现类串成一个责任链，调用这个责任链的类开启了默认事务，如果外围类发生异常，整个责任链的调用也会回滚。外围类一并回滚，在这里内外属于同一个事务。</li>
<li><strong>场景：适用于不需要事务支持但希望在事务中运行的操作。例如，日志记录功能，它可以在事务中运行以确保日志与实际业务操作保持一致，但如果事务不存在，也可以正常执行。一般来说，如果外围类调用失败，内部的日志记录将会停止记录此次操作，但不会影响外围类的其他不在事务内的上下文日志记录</strong></li>
</ul>
</li>
<li><p><strong>PROPAGATION_MANDATORY</strong></p>
<ul>
<li>支持当前事务，如果当前存在事务，则加入该事务。</li>
<li>如果当前没有事务，则抛出异常。</li>
<li><strong>场景：适用于必须在一个事务中执行的操作。例如，某些敏感操作，如果事务不存在可能无法保证数据一致性，因此抛出异常是合理的选择。这也是属于责任链的安全机制，如果一个没有事务配置的类调用了需要事务的类，则会触发责任链内的异常抛出</strong></li>
</ul>
</li>
<li><p><strong>PROPAGATION_REQUIRES_NEW</strong></p>
<ul>
<li>新建事务，如果当前存在事务，则将当前事务挂起。</li>
<li>如果当前没有事务，则新建一个事务。</li>
<li><strong>场景：适用于需要独立事务的场景，例如，当一个方法需要保证其操作绝对独立于其他操作时，可以使用此属性。例如，处理支付操作，需要确保支付操作在一个独立的事务中完成，不受其他操作的影响。比如各大银行都会有的骚操作：支付流程必须在一个事务中执行！</strong></li>
</ul>
</li>
<li><p><strong>PROPAGATION_NOT_SUPPORTED</strong></p>
<ul>
<li>以非事务方式执行，如果当前存在事务，则将当前事务挂起。</li>
<li>如果当前没有事务，则以非事务方式执行。</li>
<li>是指如果存在事务则将这个事务挂起，并使用新的数据库连接。新的数据库连接不使用事务</li>
<li><strong>场景：适用于不需要事务支持的操作，但希望在事务存在时暂停它。例如，某些不需要持久化的查询操作，可以在事务中暂停，以提高性能。还是记录日志，日志记录可以多一条和少一条，但不会影响实际业务操作。上级方法抛出异常不会影响日志记录，同样，日志记录抛出异常不会影响上级方法</strong></li>
</ul>
</li>
<li><p><strong>PROPAGATION_NEVER</strong></p>
<ul>
<li>如果上级方法有事务，则抛出异常。</li>
<li>如果调用 Propagation.NEVER 的方法时，当前线程已经有活跃的事务，Spring 会抛出异常（比如 IllegalTransactionStateException）。因此，使用时需要确保调用上下文符合预期。</li>
<li>它与 Propagation.NOT_SUPPORTED 类似，但区别在于：NOT_SUPPORTED 会暂停当前事务并以非事务方式运行，而 NEVER 直接拒绝任何事务上下文。</li>
<li><strong>场景 适用于明确要求非事务环境的场景(日志记录、监控操作或某些只读操作)，通常是为了性能优化、逻辑独立性或特定业务需求。(更主要的是避免事务带来的性能开销,以及业务逻辑要求某个方法必须独立于调用方的事务上下文（比如某些外部系统调用或非事务性操作）)如果你需要的是“暂停事务但仍运行”，可以考虑 Propagation.NOT_SUPPORTED；而如果完全拒绝事务，NEVER 是更严格的选择。</strong></li>
</ul>
</li>
<li><p><strong>PROPAGATION_NESTED</strong></p>
<ul>
<li>如果当前方法有事务，则在嵌套事务内执行。</li>
<li>如果当前方法没有事务，则与 <code>PROPAGATION_REQUIRED</code> 行为相同。</li>
<li><strong>场景：适用于可能需要回滚到某个中间状态的操作。例如，在一个复杂的业务流程中，某些子操作失败时，可能需要回滚到子操作之前的状态，而不是整个事务。</strong></li>
</ul>
</li>
</ul>
<p>在订单支付操作中, 整个流程默认 Propagation.REQUIRED ， 但是在支付过程中，没必要再开启一个新事务，采用了子事务的单独处理回滚，所以这里采用了 Propagation.NESTED 。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(Order order)</span> &#123;<br>    saveOrder(order); <span class="hljs-comment">// 保存订单</span><br>    nestedProcessPayment(order); <span class="hljs-comment">// 处理支付，可能失败但不影响订单保存</span><br>&#125;<br><br><span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nestedProcessPayment</span><span class="hljs-params">(Order order)</span> &#123;<br>    <span class="hljs-comment">// 尝试扣款</span><br>    <span class="hljs-keyword">if</span> (!paymentService.charge(order)) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PaymentException</span>(<span class="hljs-string">&quot;Payment failed&quot;</span>);<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>或者一个老赖资金被冻结的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account from, Account to, BigDecimal amount)</span> &#123;<br>    deductFromAccount(from, amount); <span class="hljs-comment">// 扣款</span><br>    nestedAddToAccount(to, amount);  <span class="hljs-comment">// 加款（嵌套事务）</span><br>&#125;<br><br><span class="hljs-meta">@Transactional(propagation = Propagation.NESTED)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">nestedAddToAccount</span><span class="hljs-params">(Account to, BigDecimal amount)</span> &#123;<br>    <span class="hljs-keyword">if</span> (to.isBlocked()) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AccountBlockedException</span>(<span class="hljs-string">&quot;Target account is blocked&quot;</span>);<br>    &#125;<br>    to.setBalance(to.getBalance().add(amount));<br>    accountRepository.save(to);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="嵌套事务的坑"><a href="#嵌套事务的坑" class="headerlink" title="嵌套事务的坑"></a>嵌套事务的坑</h4><p>嵌套事务依赖于底层数据库是否支持 Savepoint。如果数据库不支持（比如 MySQL 的 MyISAM 引擎），Spring 会抛出异常或无法正确工作。建议使用支持保存点的数据库（如 InnoDB）。</p>
<p> <strong>这里再看下TransactionDefinition这个常量配置类, 2003年的类，还特么是 interface!</strong><br> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">package</span> org.springframework.transaction;<br><br><span class="hljs-keyword">import</span> org.springframework.lang.Nullable;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Interface that defines Spring-compliant transaction properties.</span><br><span class="hljs-comment"> * Based on the propagation behavior definitions analogous to EJB CMT attributes.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;Note that isolation level and timeout settings will not get applied unless</span><br><span class="hljs-comment"> * an actual new transaction gets started. As only &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125;,</span><br><span class="hljs-comment"> * &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRES_NEW&#125; and &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_NESTED&#125; can cause</span><br><span class="hljs-comment"> * that, it usually doesn&#x27;t make sense to specify those settings in other cases.</span><br><span class="hljs-comment"> * Furthermore, be aware that not all transaction managers will support those</span><br><span class="hljs-comment"> * advanced features and thus might throw corresponding exceptions when given</span><br><span class="hljs-comment"> * non-default values.</span><br><span class="hljs-comment"> *</span><br><span class="hljs-comment"> * &lt;p&gt;The &#123;<span class="hljs-doctag">@link</span> #isReadOnly() read-only flag&#125; applies to any transaction context,</span><br><span class="hljs-comment"> * whether backed by an actual resource transaction or operating non-transactionally</span><br><span class="hljs-comment"> * at the resource level. In the latter case, the flag will only apply to managed</span><br><span class="hljs-comment"> * resources within the application, such as a Hibernate &#123;<span class="hljs-doctag">@code</span> Session&#125;.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">TransactionDefinition</span> &#123;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction; create a new one if none exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;This is typically the default setting of a transaction definition,</span><br><span class="hljs-comment">	 * and typically defines a transaction synchronization scope.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_REQUIRED</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction; execute non-transactionally if none exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; For transaction managers with transaction synchronization,</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> PROPAGATION_SUPPORTS&#125; is slightly different from no transaction</span><br><span class="hljs-comment">	 * at all, as it defines a transaction scope that synchronization might apply to.</span><br><span class="hljs-comment">	 * As a consequence, the same resources (a JDBC &#123;<span class="hljs-doctag">@code</span> Connection&#125;, a</span><br><span class="hljs-comment">	 * Hibernate &#123;<span class="hljs-doctag">@code</span> Session&#125;, etc) will be shared for the entire specified</span><br><span class="hljs-comment">	 * scope. Note that the exact behavior depends on the actual synchronization</span><br><span class="hljs-comment">	 * configuration of the transaction manager!</span><br><span class="hljs-comment">	 * &lt;p&gt;In general, use &#123;<span class="hljs-doctag">@code</span> PROPAGATION_SUPPORTS&#125; with care! In particular, do</span><br><span class="hljs-comment">	 * not rely on &#123;<span class="hljs-doctag">@code</span> PROPAGATION_REQUIRED&#125; or &#123;<span class="hljs-doctag">@code</span> PROPAGATION_REQUIRES_NEW&#125;</span><br><span class="hljs-comment">	 * &lt;i&gt;within&lt;/i&gt; a &#123;<span class="hljs-doctag">@code</span> PROPAGATION_SUPPORTS&#125; scope (which may lead to</span><br><span class="hljs-comment">	 * synchronization conflicts at runtime). If such nesting is unavoidable, make sure</span><br><span class="hljs-comment">	 * to configure your transaction manager appropriately (typically switching to</span><br><span class="hljs-comment">	 * &quot;synchronization on actual transaction&quot;).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#setTransactionSynchronization</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.support.AbstractPlatformTransactionManager#SYNCHRONIZATION_ON_ACTUAL_TRANSACTION</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_SUPPORTS</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Support a current transaction; throw an exception if no current transaction</span><br><span class="hljs-comment">	 * exists. Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that transaction synchronization within a &#123;<span class="hljs-doctag">@code</span> PROPAGATION_MANDATORY&#125;</span><br><span class="hljs-comment">	 * scope will always be driven by the surrounding transaction.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_MANDATORY</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Create a new transaction, suspending the current transaction if one exists.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual transaction suspension will not work out-of-the-box</span><br><span class="hljs-comment">	 * on all transaction managers. This in particular applies to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.jta.JtaTransactionManager&#125;,</span><br><span class="hljs-comment">	 * which requires the &#123;<span class="hljs-doctag">@code</span> javax.transaction.TransactionManager&#125; to be</span><br><span class="hljs-comment">	 * made available it to it (which is server-specific in standard Java EE).</span><br><span class="hljs-comment">	 * &lt;p&gt;A &#123;<span class="hljs-doctag">@code</span> PROPAGATION_REQUIRES_NEW&#125; scope always defines its own</span><br><span class="hljs-comment">	 * transaction synchronizations. Existing synchronizations will be suspended</span><br><span class="hljs-comment">	 * and resumed appropriately.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_REQUIRES_NEW</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Do not support a current transaction; rather always execute non-transactionally.</span><br><span class="hljs-comment">	 * Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual transaction suspension will not work out-of-the-box</span><br><span class="hljs-comment">	 * on all transaction managers. This in particular applies to</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.transaction.jta.JtaTransactionManager&#125;,</span><br><span class="hljs-comment">	 * which requires the &#123;<span class="hljs-doctag">@code</span> javax.transaction.TransactionManager&#125; to be</span><br><span class="hljs-comment">	 * made available it to it (which is server-specific in standard Java EE).</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that transaction synchronization is &lt;i&gt;not&lt;/i&gt; available within a</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> PROPAGATION_NOT_SUPPORTED&#125; scope. Existing synchronizations</span><br><span class="hljs-comment">	 * will be suspended and resumed appropriately.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.transaction.jta.JtaTransactionManager#setTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_NOT_SUPPORTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Do not support a current transaction; throw an exception if a current transaction</span><br><span class="hljs-comment">	 * exists. Analogous to the EJB transaction attribute of the same name.</span><br><span class="hljs-comment">	 * &lt;p&gt;Note that transaction synchronization is &lt;i&gt;not&lt;/i&gt; available within a</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@code</span> PROPAGATION_NEVER&#125; scope.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_NEVER</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Execute within a nested transaction if a current transaction exists,</span><br><span class="hljs-comment">	 * behave like &#123;<span class="hljs-doctag">@link</span> #PROPAGATION_REQUIRED&#125; otherwise. There is no</span><br><span class="hljs-comment">	 * analogous feature in EJB.</span><br><span class="hljs-comment">	 * &lt;p&gt;&lt;b&gt;<span class="hljs-doctag">NOTE:</span>&lt;/b&gt; Actual creation of a nested transaction will only work on</span><br><span class="hljs-comment">	 * specific transaction managers. Out of the box, this only applies to the JDBC</span><br><span class="hljs-comment">	 * &#123;<span class="hljs-doctag">@link</span> org.springframework.jdbc.datasource.DataSourceTransactionManager&#125;</span><br><span class="hljs-comment">	 * when working on a JDBC 3.0 driver. Some JTA providers might support</span><br><span class="hljs-comment">	 * nested transactions as well.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> org.springframework.jdbc.datasource.DataSourceTransactionManager</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">PROPAGATION_NESTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">6</span>;<br><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Use the default isolation level of the underlying datastore.</span><br><span class="hljs-comment">	 * All other levels correspond to the JDBC isolation levels.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> java.sql.Connection</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_DEFAULT</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicates that dirty reads, non-repeatable reads and phantom reads</span><br><span class="hljs-comment">	 * can occur.</span><br><span class="hljs-comment">	 * &lt;p&gt;This level allows a row changed by one transaction to be read by another</span><br><span class="hljs-comment">	 * transaction before any changes in that row have been committed (a &quot;dirty read&quot;).</span><br><span class="hljs-comment">	 * If any of the changes are rolled back, the second transaction will have</span><br><span class="hljs-comment">	 * retrieved an invalid row.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> java.sql.Connection#TRANSACTION_READ_UNCOMMITTED</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_READ_UNCOMMITTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_READ_UNCOMMITTED;</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicates that dirty reads are prevented; non-repeatable reads and</span><br><span class="hljs-comment">	 * phantom reads can occur.</span><br><span class="hljs-comment">	 * &lt;p&gt;This level only prohibits a transaction from reading a row</span><br><span class="hljs-comment">	 * with uncommitted changes in it.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> java.sql.Connection#TRANSACTION_READ_COMMITTED</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_READ_COMMITTED</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_READ_COMMITTED;</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicates that dirty reads and non-repeatable reads are prevented;</span><br><span class="hljs-comment">	 * phantom reads can occur.</span><br><span class="hljs-comment">	 * &lt;p&gt;This level prohibits a transaction from reading a row with uncommitted changes</span><br><span class="hljs-comment">	 * in it, and it also prohibits the situation where one transaction reads a row,</span><br><span class="hljs-comment">	 * a second transaction alters the row, and the first transaction re-reads the row,</span><br><span class="hljs-comment">	 * getting different values the second time (a &quot;non-repeatable read&quot;).</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> java.sql.Connection#TRANSACTION_REPEATABLE_READ</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_REPEATABLE_READ</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_REPEATABLE_READ;</span><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Indicates that dirty reads, non-repeatable reads and phantom reads</span><br><span class="hljs-comment">	 * are prevented.</span><br><span class="hljs-comment">	 * &lt;p&gt;This level includes the prohibitions in &#123;<span class="hljs-doctag">@link</span> #ISOLATION_REPEATABLE_READ&#125;</span><br><span class="hljs-comment">	 * and further prohibits the situation where one transaction reads all rows that</span><br><span class="hljs-comment">	 * satisfy a &#123;<span class="hljs-doctag">@code</span> WHERE&#125; condition, a second transaction inserts a row</span><br><span class="hljs-comment">	 * that satisfies that &#123;<span class="hljs-doctag">@code</span> WHERE&#125; condition, and the first transaction</span><br><span class="hljs-comment">	 * re-reads for the same condition, retrieving the additional &quot;phantom&quot; row</span><br><span class="hljs-comment">	 * in the second read.</span><br><span class="hljs-comment">	 * <span class="hljs-doctag">@see</span> java.sql.Connection#TRANSACTION_SERIALIZABLE</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">ISOLATION_SERIALIZABLE</span> <span class="hljs-operator">=</span> <span class="hljs-number">8</span>;  <span class="hljs-comment">// same as java.sql.Connection.TRANSACTION_SERIALIZABLE;</span><br><br><br>	<span class="hljs-comment">/**</span><br><span class="hljs-comment">	 * Use the default timeout of the underlying transaction system,</span><br><span class="hljs-comment">	 * or none if timeouts are not supported.</span><br><span class="hljs-comment">	 */</span><br>	<span class="hljs-type">int</span> <span class="hljs-variable">TIMEOUT_DEFAULT</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>	***********************<br>&#125;<br></code></pre></td></tr></table></figure></p>
<p>理论上， TransactionDefinition 这个接口定义了 Spring 事务的属性，包括传播行为、隔离级别、超时等。</p>
<p>Propagation 枚举类定义了 Spring 事务传播行为，包括 REQUIRED、SUPPORTS、MANDATORY、REQUIRES_NEW、NOT_SUPPORTED、NEVER、NESTED 等。</p>
<p>ISOLATION_DEFAULT、ISOLATION_READ_UNCOMMITTED、ISOLATION_READ_COMMITTED、ISOLATION_REPEATABLE_READ、ISOLATION_SERIALIZABLE 这几个常量定义了 Spring 事务的隔离级别。</p>
<p>TIMEOUT_DEFAULT 常量定义了 Spring 事务的超时时间。</p>
<p>这里的枚举类和常量类都是 Spring 事务的基础，可以根据实际情况进行配置。</p>
<h2 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h2><p>@Transactional 作用在 <strong>类</strong> 和 <strong>public方法</strong> 和并<strong>不被推荐</strong>的 <strong>interface</strong> ，作用范围顾名思义。其默认配置回滚 RunTimeException 及其子类，也可以直接指定 回滚 Exceptioin 及其子类：<code>@Transactional(rollbackFor = Exception.class) </code></p>
<p>或者指定事务传播行为：<code>@Transactional(propagation = Propagation.REQUIRED)</code></p>
<p>或者指定事务隔离级别：<code>@Transactional(isolation = Isolation.SERIALIZABLE)</code></p>
<p>或者指定事务超时时间：<code>@Transactional(timeout = 30)</code></p>
<p>或者指定事务传播行为、隔离级别、超时时间,回滚异常类：<code>@Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.SERIALIZABLE, timeout = 30,rollbackFor = Exception.class)</code></p>
<hr>
<h2 id="事务管理器-（编程式事务管理）"><a href="#事务管理器-（编程式事务管理）" class="headerlink" title="事务管理器 （编程式事务管理）"></a>事务管理器 （编程式事务管理）</h2><p>Spring 事务管理器是 Spring 事务的核心，负责事务的提交、回滚、资源的获取和释放等事务管理操作。</p>
<p>Spring 提供了多种事务管理器，包括 DataSourceTransactionManager、HibernateTransactionManager、JpaTransactionManager、JtaTransactionManager 等。</p>
<p>DataSourceTransactionManager 用于管理 JDBC 事务，它会自动获取 JDBC Connection，并对 Connection 进行事务的提交、回滚、关闭等操作。</p>
<p>HibernateTransactionManager 用于管理 Hibernate 事务，它会自动获取 Hibernate Session，并对 Session 进行事务的提交、回滚、关闭等操作。</p>
<p>JpaTransactionManager 用于管理 JPA 事务，它会自动获取 JPA EntityManager，并对 EntityManager 进行事务的提交、回滚、关闭等操作。</p>
<p>Spring 事务管理器的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;entityManagerFactory&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;entityManagerFactory&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;entityManagerFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jpaVendorAdapter&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;jpaVendorAdapter&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;packagesToScan&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.example.entity&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;jpaVendorAdapter&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;database&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;MYSQL&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;showSql&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h3 id="声明式事务调用方式"><a href="#声明式事务调用方式" class="headerlink" title="声明式事务调用方式"></a>声明式事务调用方式</h3><h3 id="Transactional-注解失效场景"><a href="#Transactional-注解失效场景" class="headerlink" title="@Transactional 注解失效场景"></a>@Transactional 注解失效场景</h3><h4 id="1-方法调用为内部调用（非代理调用）"><a href="#1-方法调用为内部调用（非代理调用）" class="headerlink" title="1.方法调用为内部调用（非代理调用）"></a>1.方法调用为内部调用（非代理调用）</h4><p>pring 的事务管理是基于 AOP（面向切面编程）实现的，默认通过动态代理（JDK 代理或 CGLIB 代理）增强目标类。如果在同一个类中，方法 A 调用方法 B，而 @Transactional 注解在方法 B 上，由于<strong>没有经过代理</strong>，事务不会生效。</p>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> &#123;<br>        methodB(); <span class="hljs-comment">// 直接内部调用</span><br>    &#125;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 事务逻辑</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>但是我想通过直接在类中进行内部调用如何，该怎样操作呢？</p>
<p>需要在入口类加上 <code>@EnableAspectJAutoProxy</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> &#123;<br>			<span class="hljs-comment">//</span><br>				<span class="hljs-type">MyService</span> <span class="hljs-variable">myService</span> <span class="hljs-operator">=</span> (MyService) AopContext.currentProxy();<br>        myService.methodB(); <span class="hljs-comment">// 直接内部调用</span><br>    &#125;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 事务逻辑</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>或者实现 ApplicationContextAware 接口 ，获取代理类在容器里的Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br><br>	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ApplicationContext applicationContext;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> &#123;<br>			<br>			 <span class="hljs-type">MyService</span> <span class="hljs-variable">myService</span> <span class="hljs-operator">=</span> applicationContext.getBean(MyService.class); <br>        myService.methodB(); <br>    &#125;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 事务逻辑</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>以及调用 @Autowired  或者 @Resource 注入 MyService 类。<strong>优雅吗？</strong></p>
<p><strong>这里，理论上，一切可以获取Spring 容器中的Bean 都可以进行调用方法!</strong></p>
<h4 id="方法不是-public-的"><a href="#方法不是-public-的" class="headerlink" title="方法不是 public 的"></a>方法不是 public 的</h4><p>Spring AOP 只能代理 public 方法。如果 @Transactional 注解标注在非 public 方法上（例如 private 或 protected），事务不会生效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myMethod</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">// 事务逻辑 (私有方法不生效)</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="异常被捕获但未抛出"><a href="#异常被捕获但未抛出" class="headerlink" title="异常被捕获但未抛出"></a>异常被捕获但未抛出</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myMethod</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 可能抛出异常的操作</span><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">// 异常被捕获，未抛出 not throwing the exception</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="事务传播行为不生效"><a href="#事务传播行为不生效" class="headerlink" title="事务传播行为不生效"></a>事务传播行为不生效</h4><p>事务传播属性配置不当<br>原因：@Transactional 的 propagation 属性默认是 Propagation.REQUIRED，表示如果当前存在事务则加入，不存在则新建事务。如果设置为 PROPAGATION_SUPPORTS、PROPAGATION_NOT_SUPPORTED、 PROPAGATION_NEVER，则事务不会生效。<br>这些单独配置且方法外部上级方法没有配置事务，都会造成方法内的事务不生效。</p>
<h4 id="个别数据库引擎不支持事务"><a href="#个别数据库引擎不支持事务" class="headerlink" title="个别数据库引擎不支持事务"></a>个别数据库引擎不支持事务</h4><h4 id="多线程导致事务失效"><a href="#多线程导致事务失效" class="headerlink" title="多线程导致事务失效"></a>多线程导致事务失效</h4><p>Spring 的事务是基于 ThreadLocal 实现的，每个线程有独立的事务上下文。如果在方法中开启新线程执行数据库操作，新线程无法继承原线程的事务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Transactional</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myMethod</span><span class="hljs-params">()</span> &#123;<br>	myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 1&quot;</span>)); <span class="hljs-comment">// 主线程的事务上下文</span><br>    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>        <span class="hljs-comment">// 数据库操作在新线程中，无法使用事务</span><br>    &#125;).start();<br><br>		CompletableFuture.runAsync(() -&gt; &#123;<br>				myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 2&quot;</span>)); <span class="hljs-comment">// 在新线程中执行</span><br>		&#125;);<br><br>		Future&lt;?&gt; future = executorService.submit(() -&gt; &#123;<br>            myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 3&quot;</span>)); <span class="hljs-comment">// 在新线程中执行</span><br>        &#125;);<br>        future.get(); <span class="hljs-comment">// 等待任务完成</span><br><br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Rollback&quot;</span>); <span class="hljs-comment">// 模拟异常回滚</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>CompletableFuture.runAsync 默认使用 ForkJoinPool.commonPool() 执行任务，新线程没有继承主线程的 TransactionManager 的 ThreadLocal 事务上下文，导致事务失效。</p>
<p>Future 通过线程池执行任务时，新线程无法访问主线程的 ThreadLocal 事务状态，因此事务失效。</p>
<h5 id="解决方式"><a href="#解决方式" class="headerlink" title="解决方式"></a>解决方式</h5><ul>
<li>使用编程式事务管理<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MyRepository myRepository;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> TransactionTemplate transactionTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myTransactionalMethod</span><span class="hljs-params">()</span> &#123;<br>        transactionTemplate.execute(status -&gt; &#123;<br>            myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 1&quot;</span>));<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;);<br><br>        CompletableFuture.runAsync(() -&gt; &#123;<br>            transactionTemplate.execute(status -&gt; &#123;<br>                myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 2&quot;</span>));<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;);<br>        &#125;);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
这种方式每个异步任务有独立的事务，无法保证整体一致性。如果需要整体回滚，需结合其他机制（如补偿逻辑）。</li>
</ul>
<h5 id="传递事务上下文到新线程"><a href="#传递事务上下文到新线程" class="headerlink" title="传递事务上下文到新线程"></a>传递事务上下文到新线程</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MyRepository myRepository;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> PlatformTransactionManager transactionManager;<br><br>    <span class="hljs-meta">@Transactional</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">myTransactionalMethod</span><span class="hljs-params">()</span> &#123;<br>        myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 1&quot;</span>));<br><br>        <span class="hljs-type">TransactionDefinition</span> <span class="hljs-variable">definition</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultTransactionDefinition</span>();<br>        <span class="hljs-type">TransactionStatus</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> transactionManager.getTransaction(definition);<br><br>        CompletableFuture.runAsync(() -&gt; &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                myRepository.save(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Entity</span>(<span class="hljs-string">&quot;Step 2&quot;</span>));<br>                transactionManager.commit(status); <span class="hljs-comment">// 手动提交</span><br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                transactionManager.rollback(status); <span class="hljs-comment">// 手动回滚</span><br>            &#125;<br>        &#125;);<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Rollback&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>通过 TransactionSynchronizationManager 保存主线程的事务状态到子线程中再恢复。</p>
<ul>
<li>尽量避免在事务方法中引入异步操作。</li>
<li><strong>如果必须异步，可以使用编程式事务管理或传递事务上下文，但需权衡复杂度和一致性需求。</strong></li>
</ul>
<h4 id="未启用事务管理器-Spring-需要考虑-，Spring-Boot-自动配置"><a href="#未启用事务管理器-Spring-需要考虑-，Spring-Boot-自动配置" class="headerlink" title="未启用事务管理器(Spring 需要考虑 ，Spring Boot 自动配置)"></a>未启用事务管理器(Spring 需要考虑 ，Spring Boot 自动配置)</h4><p>原因：如果项目中没有配置 @EnableTransactionManagement 或缺少事务管理器（DataSourceTransactionManager）的 Bean，@Transactional 将不起作用。<br>解决办法：<br>在配置类上添加 @EnableTransactionManagement。<br>确保正确配置数据源和事务管理器：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.orm.jpa.JpaTransactionManager&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;entityManagerFactory&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;entityManagerFactory&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;entityManagerFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jpaVendorAdapter&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;jpaVendorAdapter&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;packagesToScan&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.example.entity&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;jpaVendorAdapter&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.orm.jpa.vendor.HibernateJpaVendorAdapter&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;database&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;MYSQL&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;showSql&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DriverManagerDataSource&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span>		<br>		<span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>/&gt;</span>		<br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span>		<br>    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;root&quot;</span>/&gt;</span>		<br><span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>或者 ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Bean</span><br><span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(DataSource dataSource)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(dataSource);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Spring Boot 自动配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">类来自 <span class="hljs-meta">@SpringBootApplication</span> =&gt; <span class="hljs-meta">@EnableAutoConfiguration</span> =&gt; <span class="hljs-meta">@Import(AutoConfigurationImportSelector.class)</span><br><br><br>	<span class="hljs-meta">@Override</span><br>	<span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;<br>		<span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>			<span class="hljs-keyword">return</span> NO_IMPORTS;<br>		&#125;<br>		<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> getAutoConfigurationEntry(annotationMetadata);<br>		<span class="hljs-keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());<br>	&#125;<br><br>	<span class="hljs-keyword">protected</span> AutoConfigurationEntry <span class="hljs-title function_">getAutoConfigurationEntry</span><span class="hljs-params">(AnnotationMetadata annotationMetadata)</span> &#123;<br>		<span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>			<span class="hljs-keyword">return</span> EMPTY_ENTRY;<br>		&#125;<br>		<span class="hljs-type">AnnotationAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> getAttributes(annotationMetadata);<br>		List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata, attributes);<br>		configurations = removeDuplicates(configurations);<br>		Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);<br>		checkExcludedClasses(configurations, exclusions);<br>		configurations.removeAll(exclusions);<br>		configurations = getConfigurationClassFilter().filter(configurations);<br>		fireAutoConfigurationImportEvents(configurations, exclusions);<br>		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AutoConfigurationEntry</span>(configurations, exclusions);<br>	&#125;<br><br>	<span class="hljs-keyword">protected</span> List&lt;String&gt; <span class="hljs-title function_">getCandidateConfigurations</span><span class="hljs-params">(AnnotationMetadata metadata, AnnotationAttributes attributes)</span> &#123;<br>		List&lt;String&gt; configurations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>(SpringFactoriesLoader.loadFactoryNames(<span class="hljs-built_in">this</span>.getSpringFactoriesLoaderFactoryClass(), <span class="hljs-built_in">this</span>.getBeanClassLoader()));<br>		ImportCandidates.load(AutoConfiguration.class, <span class="hljs-built_in">this</span>.getBeanClassLoader()).forEach(configurations::add);<br>		Assert.notEmpty(configurations, <span class="hljs-string">&quot;No auto configuration classes found in META-INF/spring.factories nor in META-INF/spring/org.springframework.boot.autoconfigure.AutoConfiguration.imports. If you are using a custom packaging, make sure that file is correct.&quot;</span>);<br>		<span class="hljs-keyword">return</span> configurations;<br>	&#125;<br></code></pre></td></tr></table></figure>

<p>这里去找 META-INF&#x2F;spring.factories 文件</p>
<p>嗯，啥都没有<br>但是在下方有个类似的同名文件： 	<code>spring-autoconfigure-metadata.properties</code><br>看下被谁引用了: AutoConfigurationMetadataLoader</p>
<p>调用方也是 AutoConfigurationImportSelector</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> AutoConfigurationMetadata <span class="hljs-title function_">getAutoConfigurationMetadata</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoConfigurationMetadata == <span class="hljs-literal">null</span>) &#123;<br>		<span class="hljs-built_in">this</span>.autoConfigurationMetadata = AutoConfigurationMetadataLoader.loadMetadata(<span class="hljs-built_in">this</span>.beanClassLoader);<br>	&#125;<br>	<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.autoConfigurationMetadata;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>继续向上追查</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java"><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;<br>	<span class="hljs-keyword">if</span> (!isEnabled(annotationMetadata)) &#123;<br>		<span class="hljs-keyword">return</span> NO_IMPORTS;<br>	&#125;<br>	<span class="hljs-type">AutoConfigurationEntry</span> <span class="hljs-variable">autoConfigurationEntry</span> <span class="hljs-operator">=</span> getAutoConfigurationEntry(annotationMetadata);<br>	<span class="hljs-keyword">return</span> StringUtils.toStringArray(autoConfigurationEntry.getConfigurations());<br>&#125;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> Iterable&lt;Entry&gt; <span class="hljs-title function_">selectImports</span><span class="hljs-params">()</span> &#123;<br>	<span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.autoConfigurationEntries.isEmpty()) &#123;<br>		<span class="hljs-keyword">return</span> Collections.emptyList();<br>	&#125;<br>	Set&lt;String&gt; allExclusions = <span class="hljs-built_in">this</span>.autoConfigurationEntries.stream()<br>			.map(AutoConfigurationEntry::getExclusions).flatMap(Collection::stream).collect(Collectors.toSet());<br>	Set&lt;String&gt; processedConfigurations = <span class="hljs-built_in">this</span>.autoConfigurationEntries.stream()<br>			.map(AutoConfigurationEntry::getConfigurations).flatMap(Collection::stream)<br>			.collect(Collectors.toCollection(LinkedHashSet::<span class="hljs-keyword">new</span>));<br>	processedConfigurations.removeAll(allExclusions);<br><br><span class="hljs-comment">// 这里调用了  getAutoConfigurationMetadata 方法</span><br>	<span class="hljs-keyword">return</span> sortAutoConfigurations(processedConfigurations, getAutoConfigurationMetadata()).stream()<br>			.map((importClassName) -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Entry</span>(<span class="hljs-built_in">this</span>.entries.get(importClassName), importClassName))<br>			.collect(Collectors.toList());<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注意。这里有两个 selectImports 方法，第一个属于 <code>ImportSelector</code> 第二个属于 <code>DeferredImportSelector</code>。<br>DeferredImportSelector 接口 又继承了 ImportSelector。</p>
<p><strong>DeferredImportSelector 作为 ImportSelector 的延迟实现，在 ApplicationContext 初始化时，会调用 selectImports 方法，而 selectImports 方法又会调用DeferredImportSelector 的 getAutoConfigurationEntry 方法。</strong>		</p>
<p>DeferredImportSelector 里还有 group 方法，属于是逐步为 ImportSelector 细化解析流程<br>然后来看下 <code>spring-autoconfigure-metadata.properties</code> 里是如何配置的：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs sh">org.springframework.boot.autoconfigure.batch.BatchConfigurerConfiguration.ConditionalOnClass=org.springframework.transaction.PlatformTransactionManager<br>org.springframework.boot.autoconfigure.data.jdbc.JdbcRepositoriesAutoConfiguration.ConditionalOnBean=org.springframework.jdbc.core.namedparam.NamedParameterJdbcOperations,org.springframework.transaction.PlatformTransactionManager<br><br><br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration=<br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration<span class="hljs-variable">$EnableTransactionManagementConfiguration</span>=<br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration<span class="hljs-variable">$EnableTransactionManagementConfiguration</span>.ConditionalOnBean=org.springframework.transaction.TransactionManager<br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration<span class="hljs-variable">$TransactionTemplateConfiguration</span>=<br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration<span class="hljs-variable">$TransactionTemplateConfiguration</span>.ConditionalOnSingleCandidate=org.springframework.transaction.PlatformTransactionManager<br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration.AutoConfigureAfter=org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration,org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration,org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration,org.springframework.boot.autoconfigure.data.neo4j.Neo4jDataAutoConfiguration<br>org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration.ConditionalOnClass=org.springframework.transaction.PlatformTransactionManager<br>org.springframework.boot.autoconfigure.transaction.jta.AtomikosJtaConfiguration=<br>org.springframework.boot.autoconfigure.transaction.jta.AtomikosJtaConfiguration<span class="hljs-variable">$AtomikosJtaJmsConfiguration</span>=<br>org.springframework.boot.autoconfigure.transaction.jta.AtomikosJtaConfiguration<span class="hljs-variable">$AtomikosJtaJmsConfiguration</span>.ConditionalOnClass=javax.jms.Message<br>org.springframework.boot.autoconfigure.transaction.jta.AtomikosJtaConfiguration.ConditionalOnClass=com.atomikos.icatch.jta.UserTransactionManager,org.springframework.transaction.jta.JtaTransactionManager<br>org.springframework.boot.autoconfigure.transaction.jta.JndiJtaConfiguration=<br>org.springframework.boot.autoconfigure.transaction.jta.JndiJtaConfiguration.ConditionalOnClass=org.springframework.transaction.jta.JtaTransactionManager<br>org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration=<br>org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration.AutoConfigureBefore=org.springframework.boot.autoconfigure.jdbc.XADataSourceAutoConfiguration,org.springframework.boot.autoconfigure.jms.activemq.ActiveMQAutoConfiguration,org.springframework.boot.autoconfigure.jms.artemis.ArtemisAutoConfiguration,org.springframework.boot.autoconfigure.orm.jpa.HibernateJpaAutoConfiguration<br>org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration.ConditionalOnClass=javax.transaction.Transaction<br></code></pre></td></tr></table></figure>

<p>直接AI 解释下：</p>
<h5 id="1-org-springframework-boot-autoconfigure-transaction-TransactionAutoConfiguration"><a href="#1-org-springframework-boot-autoconfigure-transaction-TransactionAutoConfiguration" class="headerlink" title="1. org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration"></a>1. org.springframework.boot.autoconfigure.transaction.TransactionAutoConfiguration</h5><p>这是 Spring Boot 提供的事务管理的自动配置类。它负责在适当的条件下自动配置事务相关的 bean，比如 TransactionManager 和 TransactionTemplate。</p>
<p>ConditionalOnClass&#x3D;org.springframework.transaction.PlatformTransactionManager<br>这个注解表示该自动配置类只有在类路径中存在 PlatformTransactionManager（Spring 的事务管理核心接口）时才会生效。这是 Spring Boot 条件配置的典型用法，确保只有在事务管理相关依赖存在时才启用配置。<br>AutoConfigureAfter&#x3D;…<br>表示这个配置类会在指定的其他自动配置类（如 JtaAutoConfiguration, HibernateJpaAutoConfiguration, DataSourceTransactionManagerAutoConfiguration 等）之后执行。这确保事务管理的配置能够依赖于数据库、JPA 或 JTA 的配置完成后再生效。</p>
<h5 id="2-TransactionAutoConfiguration-EnableTransactionManagementConfiguration"><a href="#2-TransactionAutoConfiguration-EnableTransactionManagementConfiguration" class="headerlink" title="2. TransactionAutoConfiguration$EnableTransactionManagementConfiguration"></a>2. TransactionAutoConfiguration$EnableTransactionManagementConfiguration</h5><p>这是 TransactionAutoConfiguration 的一个内部配置类，专门处理 @EnableTransactionManagement 相关的配置（比如支持 @Transactional 注解）。</p>
<p>ConditionalOnBean&#x3D;org.springframework.transaction.TransactionManager<br>表示这个配置只有在容器中存在 TransactionManager bean 时才会生效。TransactionManager 是事务管理的核心组件，可能由其他配置（如 JDBC、JPA 或 JTA）提供。</p>
<h5 id="3-TransactionAutoConfiguration-TransactionTemplateConfiguration"><a href="#3-TransactionAutoConfiguration-TransactionTemplateConfiguration" class="headerlink" title="3. TransactionAutoConfiguration$TransactionTemplateConfiguration"></a>3. TransactionAutoConfiguration$TransactionTemplateConfiguration</h5><p>这是另一个内部配置类，负责配置 TransactionTemplate，它是一个用于编程式事务管理的工具。</p>
<p>ConditionalOnSingleCandidate&#x3D;org.springframework.transaction.PlatformTransactionManager<br>表示只有当容器中存在单一候选的 PlatformTransactionManager 时，这个配置才会生效。如果有多个 PlatformTransactionManager bean（比如同时配置了 JPA 和 JDBC 的事务管理器），Spring Boot 不会自动配置 TransactionTemplate，以避免歧义。</p>
<h5 id="4-org-springframework-boot-autoconfigure-transaction-jta-JtaAutoConfiguration"><a href="#4-org-springframework-boot-autoconfigure-transaction-jta-JtaAutoConfiguration" class="headerlink" title="4. org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration"></a>4. org.springframework.boot.autoconfigure.transaction.jta.JtaAutoConfiguration</h5><p>这是 JTA（Java Transaction API，分布式事务）的自动配置类，适用于需要分布式事务的场景。它会根据不同的 JTA 实现（比如 Atomikos 或 JNDI）进行配置。</p>
<p>ConditionalOnClass&#x3D;javax.transaction.Transaction<br>表示只有在类路径中存在 javax.transaction.Transaction（JTA 的核心接口）时，这个配置才会生效。<br>AutoConfigureBefore&#x3D;…<br>表示这个配置会在一些其他自动配置类（如 XADataSourceAutoConfiguration, HibernateJpaAutoConfiguration 等）之前执行。这是因为 JTA 事务管理需要先于数据源或 ORM 配置完成。</p>
<h5 id="5-org-springframework-boot-autoconfigure-transaction-jta-AtomikosJtaConfiguration"><a href="#5-org-springframework-boot-autoconfigure-transaction-jta-AtomikosJtaConfiguration" class="headerlink" title="5. org.springframework.boot.autoconfigure.transaction.jta.AtomikosJtaConfiguration"></a>5. org.springframework.boot.autoconfigure.transaction.jta.AtomikosJtaConfiguration</h5><p>这是 JTA 配置的一个子类，专门为 Atomikos（一个流行的 JTA 事务管理器实现）提供支持。</p>
<p>ConditionalOnClass&#x3D;com.atomikos.icatch.jta.UserTransactionManager,org.springframework.transaction.jta.JtaTransactionManager</p>
<p>表示只有在类路径中存在 Atomikos 的 UserTransactionManager 和 Spring 的 JtaTransactionManager 时，这个配置才会生效。这是确保 Atomikos 依赖可用。</p>
<p>AtomikosJtaConfiguration$AtomikosJtaJmsConfiguration</p>
<p>这是 Atomikos 配置的子类，专门处理 JMS（Java Message Service）的事务支持。</p>
<p>ConditionalOnClass&#x3D;javax.jms.Message<br>表示只有在类路径中存在 JMS 的 Message 类时，这个 JMS 相关配置才会生效。</p>
<h5 id="6-org-springframework-boot-autoconfigure-transaction-jta-JndiJtaConfiguration"><a href="#6-org-springframework-boot-autoconfigure-transaction-jta-JndiJtaConfiguration" class="headerlink" title="6. org.springframework.boot.autoconfigure.transaction.jta.JndiJtaConfiguration"></a>6. org.springframework.boot.autoconfigure.transaction.jta.JndiJtaConfiguration</h5><p>这是另一个 JTA 配置子类，用于通过 JNDI（Java Naming and Directory Interface）查找事务管理器，通常在应用服务器（如 WebSphere、WebLogic）中使用。</p>
<p>ConditionalOnClass&#x3D;org.springframework.transaction.jta.JtaTransactionManager<br>表示只有在类路径中存在 JtaTransactionManager 时，这个配置才会生效。</p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这些配置类的作用是：</p>
<ul>
<li>模块化事务支持：Spring Boot 根据类路径中的依赖（如 JDBC、JPA、JTA、Atomikos 等）自动配置事务管理。</li>
<li>条件化加载：通过 ConditionalOnClass、ConditionalOnBean 等注解，确保只有在必要依赖存在时才启用相关配置，避免不必要的加载。</li>
<li>顺序控制：通过 AutoConfigureAfter 和 AutoConfigureBefore 控制配置的执行顺序，确保依赖关系正确。</li>
<li>灵活性：支持不同的使用场景，比如编程式事务（TransactionTemplate）、声明式事务（@Transactional）、分布式事务（JTA）等。</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_36882793/article/details/114300705">DeferredImportSelector源码解析</a></p>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/develop/" class="category-chain-item">develop</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Spting/" class="print-no-link">#Spting</a>
      
        <a href="/tags/Transactional/" class="print-no-link">#Transactional</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>who care @Transactional, how @transactional is use</div>
      <div>http://example.com/2025/03/03/who-care-Transactional-how-transactional-is-use/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>YI MING HUANG</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年3月3日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/03/01/%E3%80%8C%E5%8D%87%E7%BB%B4%E6%80%9D%E8%80%83%E3%80%8D%E6%98%AF%E8%87%AA%E6%88%91%E6%94%B9%E5%8F%98%E7%9A%84%E6%9C%AC%E8%B4%A8%E6%A0%B9%E6%BA%90/" title="「升维思考」是自我改变的本质根源">
                        <span class="hidden-mobile">「升维思考」是自我改变的本质根源</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
